### **Project Medea: Q3 2025 Engineering Plan - "The Foundation"**

**To**: The Engineering Team
**From**: Gemini, Software Architect
**Date**: July 26, 2025
**Subject**: Q3 Engineering Objectives, Roadmap, and Success Metrics

---

### **1. Executive Summary: The Goal for This Quarter**

This quarter, our singular focus is **laying a robust, scalable, and secure foundation** for Project Medea. We are transitioning from a functional prototype to a production-ready application. By the end of this quarter, we will have a containerized, multi-service application with a production-grade database, secure user authentication, and an asynchronous processing pipeline. This is the most critical engineering phase of our startup; precision and quality are paramount. **Our Q3 Motto: "Build it right, build it once."**

---

### **2. End-of-Quarter State: What Success Looks Like**

By **October 25, 2025**, we will have achieved the following state:

* **A Deployed Staging Environment**: A fully functional staging environment running on a Kubernetes cluster, mirroring our future production setup.
* **Secure User Authentication**: A complete, end-to-end user authentication and registration system. Users can sign up, log in, and all API endpoints will be secured.
* **Asynchronous LLM Processing**: All LLM interactions will be handled by a dedicated background worker, decoupled from the main API server. This ensures the API remains responsive under load.
* **Multi-Tenant Database**: A PostgreSQL database with a schema designed for multi-tenancy, ensuring complete data isolation between users.
* **Zero Technical Debt from the Sprint**: All code committed this quarter will adhere to our new, stricter coding standards, with comprehensive test coverage.

---

### **3. The Quarterly Roadmap: A 6-Sprint Plan**

This quarter is broken down into six two-week sprints. Each sprint has a clear, non-negotiable goal.

#### **Sprint 1: The Great Migration (Weeks 1-2)**

* **Goal**: Decommission SQLite and migrate to PostgreSQL.
* **Tasks**:
    1.  **Schema Design**: Finalize the multi-tenant PostgreSQL schema. Every table must have a `user_id` or `organization_id` column.
    2.  **Migration Scripts**: Write migration scripts using `postgresql-migration` to create the new schema.
    3.  **Code Refactoring**: Replace all `Database.SQLite.Simple` calls with `postgresql-simple` and `esqueleto`. This will primarily impact `src/App/DB.hs`.
    4.  **Local Environment Update**: Update `docker-compose.yml` to use the new PostgreSQL container and remove SQLite dependencies from the `.cabal` file.

#### **Sprint 2: Servant & Security (Weeks 3-4)**

* **Goal**: Replace the Scotty web framework with Servant and implement JWT-based authentication.
* **Tasks**:
    1.  **API Type Definition**: Define our entire API using Servant's type-level DSL.
    2.  **Handler Implementation**: Re-implement all web handlers from `src/App/Core.hs` and `src/App/Page/Chat.hs` as Servant handlers.
    3.  **Authentication Integration**: Integrate `servant-auth` to secure all endpoints. Create login and registration handlers.
    4.  **Testing**: Write Hspec tests for all new API endpoints, including failure cases for unauthenticated access.

#### **Sprint 3: The Asynchronous Worker (Weeks 5-6)**

* **Goal**: Decouple LLM processing from the main request-response cycle.
* **Tasks**:
    1.  **Message Queue Integration**: Integrate RabbitMQ using the `amqp` library.
    2.  **Worker Service**: Create a new executable `worker` that consumes "prompt received" messages from RabbitMQ.
    3.  **Refactor `runPrompt`**: The `runPrompt` function in `src/App/LLM.hs` will now publish a message to RabbitMQ instead of executing the LLM call directly.
    4.  **Real-time Updates**: Implement a mechanism (e.g., WebSockets) to stream the LLM's response back to the correct user client from the worker.

#### **Sprint 4: Containerization & CI (Weeks 7-8)**

* **Goal**: Create a reproducible, containerized build and a robust CI pipeline.
* **Tasks**:
    1.  **Dockerfile**: Create a multi-stage `Dockerfile` that produces a small, optimized production image.
    2.  **CI Pipeline**: Implement the CI pipeline in GitHub Actions as defined in the SOP.
    3.  **Container Registry**: Set up a container registry (e.g., AWS ECR) and configure the CI pipeline to push images to it.
    4.  **Local `Makefile`**: Enhance the `Makefile` with commands to build and run the Docker containers locally.

#### **Sprint 5: Staging Deployment (Weeks 9-10)**

* **Goal**: Deploy the application to a staging environment.
* **Tasks**:
    1.  **Kubernetes Manifests**: Write Kubernetes deployment and service manifests for the `api-server` and `worker` services.
    2.  **Cloud Provider Setup**: Provision a Kubernetes cluster (e.g., AWS EKS).
    3.  **Configuration Management**: Implement configuration loading using `configurator-ng` to manage secrets and environment-specific settings.
    4.  **Deployment Script**: Create a script to automate the deployment process to the staging environment.

#### **Sprint 6: Hardening & Polish (Weeks 11-12)**

* **Goal**: A full sprint dedicated to testing, bug fixing, and documentation. No new features.
* **Tasks**:
    1.  **End-to-End Testing**: Manually test the entire application flow in the staging environment.
    2.  **Load Testing**: Conduct basic load testing on the API to identify any immediate bottlenecks.
    3.  **Code Review & Refactoring**: Review critical sections of the new codebase and refactor for clarity and performance.
    4.  **Documentation**: Ensure all new modules and functions have clear Haddock documentation.

---

### **4. Risks & Mitigation**

* **Risk**: Underestimating the effort required to refactor from Scotty to Servant.
    * **Mitigation**: The entire team will swarm on this task during Sprint 2. We will prioritize the core API and leave less critical endpoints for later if necessary.
* **Risk**: Difficulties in debugging the asynchronous worker.
    * **Mitigation**: We will implement structured logging with `katip` from the very beginning of Sprint 3 to provide detailed, searchable logs for both the API server and the worker.
* **Risk**: Scope creep.
    * **Mitigation**: The quarterly plan is fixed. Any new feature requests will be added to the backlog for Q4. The focus is exclusively on the foundational tasks outlined above.

This plan is ambitious but achievable. It requires intense focus and a commitment to quality from every member of the team. Let's build a platform that is not just functional, but exemplary.
